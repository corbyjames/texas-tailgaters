<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Email Delivery - EmailJS</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #0f172a;
            color: #e2e8f0;
        }
        .container {
            background: #1e293b;
            padding: 30px;
            border-radius: 12px;
            border: 1px solid #334155;
        }
        h1 {
            color: #f97316;
        }
        .debug-section {
            background: #1f2937;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #334155;
        }
        .debug-section h2 {
            color: #60a5fa;
            margin-top: 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #2563eb;
        }
        button.success {
            background: #10b981;
        }
        button.success:hover {
            background: #059669;
        }
        button.warning {
            background: #f97316;
        }
        button.warning:hover {
            background: #ea580c;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            background: #0f172a;
            border: 1px solid #334155;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            display: none;
        }
        .result.show {
            display: block;
        }
        .result.success {
            border-color: #10b981;
            color: #86efac;
        }
        .result.error {
            border-color: #ef4444;
            color: #fca5a5;
        }
        .result.info {
            border-color: #3b82f6;
            color: #93bbfe;
        }
        input {
            width: 100%;
            padding: 10px;
            background: #0f172a;
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
        }
        .checklist {
            background: #064e3b;
            border: 1px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .checklist h3 {
            color: #86efac;
            margin-top: 0;
        }
        .checklist li {
            margin: 10px 0;
            color: #a7f3d0;
        }
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            color: #fbbf24;
        }
        .warning-box {
            background: #7c2d12;
            border: 2px solid #f97316;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .warning-box h3 {
            color: #fed7aa;
            margin-top: 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #334155;
        }
        th {
            background: #0f172a;
            color: #60a5fa;
        }
        td {
            background: #1e293b;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.green {
            background: #10b981;
        }
        .status-indicator.red {
            background: #ef4444;
        }
        .status-indicator.yellow {
            background: #f97316;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Email Delivery Issues</h1>
        
        <div class="warning-box">
            <h3>‚ö†Ô∏è Email Not Arriving?</h3>
            <p>Even if EmailJS returns success (200), emails might not arrive due to:</p>
            <ul>
                <li>Spam filters blocking the email</li>
                <li>Invalid "From" email in your email service provider</li>
                <li>Template configuration issues</li>
                <li>Email service provider (Gmail, Outlook, etc.) limits</li>
            </ul>
        </div>

        <div class="debug-section">
            <h2>1. Test Basic Email Delivery</h2>
            <p>Send a simple test email with minimal parameters:</p>
            <input type="email" id="testEmail" placeholder="Enter your email address">
            <button onclick="sendMinimalTest()">Send Minimal Test</button>
            <button onclick="sendWithAllFields()">Send With All Fields</button>
            <div id="minimalResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h2>2. Check EmailJS Configuration</h2>
            <button onclick="testConfiguration()">Test Configuration</button>
            <button onclick="testDirectAPI()">Test Direct API Call</button>
            <div id="configResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h2>3. Template Field Validation</h2>
            <p>Verify which fields the template is expecting:</p>
            <button onclick="testFieldCombinations()">Test Field Combinations</button>
            <div id="fieldResult" class="result"></div>
        </div>

        <div class="debug-section">
            <h2>4. Email Service Status</h2>
            <table>
                <tr>
                    <th>Component</th>
                    <th>Status</th>
                    <th>Details</th>
                </tr>
                <tr>
                    <td>Service ID</td>
                    <td><span class="status-indicator" id="serviceStatus"></span><span id="serviceText">Checking...</span></td>
                    <td id="serviceDetails"></td>
                </tr>
                <tr>
                    <td>Template ID</td>
                    <td><span class="status-indicator" id="templateStatus"></span><span id="templateText">Checking...</span></td>
                    <td id="templateDetails"></td>
                </tr>
                <tr>
                    <td>Public Key</td>
                    <td><span class="status-indicator" id="keyStatus"></span><span id="keyText">Checking...</span></td>
                    <td id="keyDetails"></td>
                </tr>
            </table>
        </div>

        <div class="checklist">
            <h3>‚úÖ EmailJS Dashboard Checklist</h3>
            <p>Check these in your <a href="https://dashboard.emailjs.com" target="_blank" style="color: #86efac;">EmailJS Dashboard</a>:</p>
            <ol>
                <li><strong>Email Service Configuration:</strong>
                    <ul>
                        <li>Is your email service (Gmail/Outlook) connected and active?</li>
                        <li>Is the "From" email address valid and verified?</li>
                        <li>Check the service status - is it showing as "Active"?</li>
                    </ul>
                </li>
                <li><strong>Template Settings:</strong>
                    <ul>
                        <li>Is "To Email" field set to <code>{{email}}</code> or <code>{{to_email}}</code>?</li>
                        <li>Is "From Name" configured correctly?</li>
                        <li>Check "Reply To" field - is it valid?</li>
                    </ul>
                </li>
                <li><strong>Email History:</strong>
                    <ul>
                        <li>Go to "Email History" in EmailJS dashboard</li>
                        <li>Are emails showing as "Sent" or "Failed"?</li>
                        <li>Click on failed emails to see error details</li>
                    </ul>
                </li>
                <li><strong>Quotas:</strong>
                    <ul>
                        <li>Check your monthly quota - have you exceeded it?</li>
                        <li>Free tier: 200 emails/month</li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="debug-section">
            <h2>5. Check Spam Folder</h2>
            <p>Emails might be going to spam. Check these folders:</p>
            <ul>
                <li>Spam / Junk folder</li>
                <li>Promotions tab (Gmail)</li>
                <li>Other / Updates tab (Gmail)</li>
                <li>Blocked senders list</li>
            </ul>
            <p>To prevent spam filtering:</p>
            <ul>
                <li>Add the sender email to your contacts</li>
                <li>Use a verified domain email as sender</li>
                <li>Avoid spam trigger words in subject/content</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module">
        // Initialize EmailJS
        const serviceId = import.meta.env.VITE_EMAILJS_SERVICE_ID;
        const templateId = import.meta.env.VITE_EMAILJS_TEMPLATE_ID;
        const publicKey = import.meta.env.VITE_EMAILJS_PUBLIC_KEY;
        
        emailjs.init(publicKey);
        
        // Check configuration on load
        window.addEventListener('load', () => {
            checkConfiguration();
        });
        
        function checkConfiguration() {
            // Check Service ID
            const serviceStatus = document.getElementById('serviceStatus');
            const serviceText = document.getElementById('serviceText');
            const serviceDetails = document.getElementById('serviceDetails');
            
            if (serviceId) {
                serviceStatus.className = 'status-indicator green';
                serviceText.textContent = 'Configured';
                serviceDetails.textContent = serviceId;
            } else {
                serviceStatus.className = 'status-indicator red';
                serviceText.textContent = 'Missing';
                serviceDetails.textContent = 'Not set in environment';
            }
            
            // Check Template ID
            const templateStatus = document.getElementById('templateStatus');
            const templateText = document.getElementById('templateText');
            const templateDetails = document.getElementById('templateDetails');
            
            if (templateId) {
                templateStatus.className = 'status-indicator green';
                templateText.textContent = 'Configured';
                templateDetails.textContent = templateId;
            } else {
                templateStatus.className = 'status-indicator red';
                templateText.textContent = 'Missing';
                templateDetails.textContent = 'Not set in environment';
            }
            
            // Check Public Key
            const keyStatus = document.getElementById('keyStatus');
            const keyText = document.getElementById('keyText');
            const keyDetails = document.getElementById('keyDetails');
            
            if (publicKey) {
                keyStatus.className = 'status-indicator green';
                keyText.textContent = 'Configured';
                keyDetails.textContent = publicKey.substring(0, 10) + '...';
            } else {
                keyStatus.className = 'status-indicator red';
                keyText.textContent = 'Missing';
                keyDetails.textContent = 'Not set in environment';
            }
        }
        
        window.sendMinimalTest = async function() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            
            const result = document.getElementById('minimalResult');
            result.className = 'result info show';
            result.textContent = 'Sending minimal test email...\n';
            
            const params = {
                to_email: email,
                email: email
            };
            
            result.textContent += `\nParameters sent:\n${JSON.stringify(params, null, 2)}\n\n`;
            
            try {
                const response = await emailjs.send(serviceId, templateId, params);
                result.className = 'result success show';
                result.textContent += `‚úÖ SUCCESS!\nStatus: ${response.status}\nText: ${response.text}\n\n`;
                result.textContent += `Check your email at: ${email}\n`;
                result.textContent += `Also check SPAM/JUNK folder!\n\n`;
                result.textContent += `If not received, check EmailJS dashboard:\nhttps://dashboard.emailjs.com/admin/emails/history`;
            } catch (error) {
                result.className = 'result error show';
                result.textContent += `‚ùå ERROR!\n`;
                result.textContent += `Status: ${error.status}\n`;
                result.textContent += `Message: ${error.text || error.message}\n\n`;
                
                if (error.status === 422) {
                    result.textContent += `\n422 Error means template expects different field names.\n`;
                    result.textContent += `Check the "To Email" field in your template settings.`;
                }
            }
        };
        
        window.sendWithAllFields = async function() {
            const email = document.getElementById('testEmail').value;
            if (!email) {
                alert('Please enter your email address');
                return;
            }
            
            const result = document.getElementById('minimalResult');
            result.className = 'result info show';
            result.textContent = 'Sending with all possible fields...\n';
            
            const params = {
                // Email variations
                to_email: email,
                email: email,
                user_email: email,
                recipient_email: email,
                
                // Template variables
                'Opposing Team': 'Test Team',
                'Game Date': 'Test Date',
                'Time': 'Test Time',
                
                // Additional common fields
                to_name: 'Test User',
                from_name: 'Texas Tailgaters',
                reply_to: 'texastailgaters@gmail.com',
                message: 'This is a test message',
                subject: 'Test Email'
            };
            
            result.textContent += `\nParameters sent:\n${JSON.stringify(params, null, 2)}\n\n`;
            
            try {
                const response = await emailjs.send(serviceId, templateId, params);
                result.className = 'result success show';
                result.textContent += `‚úÖ SUCCESS!\nStatus: ${response.status}\nText: ${response.text}\n\n`;
                result.textContent += `Check: ${email} (including SPAM folder)`;
            } catch (error) {
                result.className = 'result error show';
                result.textContent += `‚ùå ERROR!\nStatus: ${error.status}\nMessage: ${error.text || error.message}`;
            }
        };
        
        window.testConfiguration = async function() {
            const result = document.getElementById('configResult');
            result.className = 'result info show';
            result.textContent = 'Testing EmailJS configuration...\n\n';
            
            result.textContent += `Service ID: ${serviceId || 'NOT SET'}\n`;
            result.textContent += `Template ID: ${templateId || 'NOT SET'}\n`;
            result.textContent += `Public Key: ${publicKey ? publicKey.substring(0, 10) + '...' : 'NOT SET'}\n\n`;
            
            if (!serviceId || !templateId || !publicKey) {
                result.className = 'result error show';
                result.textContent += '\n‚ùå Configuration incomplete!\n';
                result.textContent += 'Check your environment variables:\n';
                result.textContent += '- VITE_EMAILJS_SERVICE_ID\n';
                result.textContent += '- VITE_EMAILJS_TEMPLATE_ID\n';
                result.textContent += '- VITE_EMAILJS_PUBLIC_KEY';
                return;
            }
            
            result.textContent += '‚úÖ All configuration values present\n\n';
            result.textContent += 'Now testing connection...\n';
            
            try {
                // Try a minimal send
                const testParams = { test: 'test' };
                await emailjs.send(serviceId, templateId, testParams);
                result.className = 'result success show';
                result.textContent += '‚úÖ Connection successful!';
            } catch (error) {
                if (error.status === 422) {
                    result.className = 'result success show';
                    result.textContent += '‚úÖ Connection successful!\n';
                    result.textContent += '(422 error is expected for incomplete params)';
                } else if (error.status === 401) {
                    result.className = 'result error show';
                    result.textContent += '‚ùå Authentication failed!\n';
                    result.textContent += 'Check your public key is correct';
                } else if (error.status === 404) {
                    result.className = 'result error show';
                    result.textContent += '‚ùå Service or template not found!\n';
                    result.textContent += 'Check service ID and template ID';
                } else {
                    result.className = 'result error show';
                    result.textContent += `‚ùå Error: ${error.text || error.message}`;
                }
            }
        };
        
        window.testDirectAPI = async function() {
            const result = document.getElementById('configResult');
            result.className = 'result info show';
            result.textContent = 'Testing direct API call...\n\n';
            
            const email = document.getElementById('testEmail').value || 'test@example.com';
            
            const payload = {
                service_id: serviceId,
                template_id: templateId,
                user_id: publicKey,
                template_params: {
                    to_email: email,
                    email: email,
                    'Opposing Team': 'API Test Team',
                    'Game Date': 'API Test Date',
                    'Time': 'API Test Time'
                }
            };
            
            result.textContent += `Payload:\n${JSON.stringify(payload, null, 2)}\n\n`;
            
            try {
                const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const responseText = await response.text();
                
                if (response.ok) {
                    result.className = 'result success show';
                    result.textContent += `‚úÖ API call successful!\n`;
                    result.textContent += `Status: ${response.status}\n`;
                    result.textContent += `Response: ${responseText}`;
                } else {
                    result.className = 'result error show';
                    result.textContent += `‚ùå API call failed!\n`;
                    result.textContent += `Status: ${response.status}\n`;
                    result.textContent += `Response: ${responseText}`;
                }
            } catch (error) {
                result.className = 'result error show';
                result.textContent += `‚ùå Network error: ${error.message}`;
            }
        };
        
        window.testFieldCombinations = async function() {
            const result = document.getElementById('fieldResult');
            result.className = 'result info show';
            result.textContent = 'Testing different field combinations...\n\n';
            
            const email = document.getElementById('testEmail').value || 'test@example.com';
            
            const combinations = [
                { name: 'to_email only', params: { to_email: email } },
                { name: 'email only', params: { email: email } },
                { name: 'user_email only', params: { user_email: email } },
                { name: 'All email fields', params: { to_email: email, email: email, user_email: email } },
                { name: 'With template vars', params: { 
                    to_email: email, 
                    'Opposing Team': 'Test', 
                    'Game Date': 'Today',
                    'Time': 'Now'
                }}
            ];
            
            for (const combo of combinations) {
                result.textContent += `Testing: ${combo.name}...\n`;
                
                try {
                    const response = await emailjs.send(serviceId, templateId, combo.params);
                    result.textContent += `  ‚úÖ Success (${response.status})\n`;
                } catch (error) {
                    result.textContent += `  ‚ùå Failed (${error.status}: ${error.text || error.message})\n`;
                }
                
                // Small delay between tests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            result.textContent += '\n\nCheck which combination worked to identify the correct field names.';
        };
        
        // Log helpful info
        console.log('%cüîç Email Delivery Debugger', 'color: #f97316; font-size: 18px; font-weight: bold');
        console.log('Configuration:');
        console.log('- Service ID:', serviceId || 'NOT SET');
        console.log('- Template ID:', templateId || 'NOT SET');
        console.log('- Public Key:', publicKey ? 'Set' : 'NOT SET');
        console.log('\nCheck EmailJS dashboard for email history:');
        console.log('https://dashboard.emailjs.com/admin/emails/history');
    </script>
</body>
</html>